name: CI/CD Pipeline (Docker Hub + DigitalOcean)

on:
  push:
    branches:
      - main

jobs:
  # ==========================================
  # JOB 1: CONSTRUIR E ENVIAR PARA O DOCKER HUB
  # ==========================================
  build-and-push:
    name: Build & Push Imagens Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --- FRONTEND ---
      - name: Build & Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: lucasmks/lms-filmes-frontend:latest

      # --- EUREKA ---
      - name: Build & Push Eureka
        uses: docker/build-push-action@v4
        with:
          context: ./eureka
          push: true
          tags: lucasmks/lms-filmes-eureka:latest

      # --- GATEWAY ---
      - name: Build & Push Gateway
        uses: docker/build-push-action@v4
        with:
          context: ./gateway
          push: true
          tags: lucasmks/lms-filmes-gateway:latest

      # --- LMS FILMES ---
      - name: Build & Push LMS Filmes
        uses: docker/build-push-action@v4
        with:
          context: ./lmsfilmes
          push: true
          tags: lucasmks/lms-filmes-lmsfilmes:latest

      # --- LMS FAVORITE ---
      - name: Build & Push LMS Favorite
        uses: docker/build-push-action@v4
        with:
          context: ./lmsfavorite
          push: true
          tags: lucasmks/lms-filmes-lmsfavorite:latest

      # --- LMS RATING ---
      - name: Build & Push LMS Rating
        uses: docker/build-push-action@v4
        with:
          context: ./lmsrating
          push: true
          tags: lucasmks/lms-filmes-lmsrating:latest

      # --- LMS EMAIL SERVICE ---
      - name: Build & Push LMS Email Service
        uses: docker/build-push-action@v4
        with:
          context: ./lms-email-service
          push: true
          tags: lucasmks/lms-filmes-lms-email:latest

  # ==========================================
  # JOB 2: ATUALIZAR O SERVIDOR (DROPLET)
  # ==========================================
  deploy:
    name: Deploy no DigitalOcean
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Executar comandos no servidor via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            # Entra na pasta onde está o docker-compose.yml
            cd /root/lms-projeto

            echo "Baixando as novas imagens do Docker Hub..."
            docker-compose pull

            echo "Reiniciando os containers..."
            docker-compose up -d

            echo "Limpando imagens antigas para liberar espaço..."
            docker image prune -f

            echo "Deploy concluído com sucesso!"
